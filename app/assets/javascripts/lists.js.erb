// $(document).on('turbolinks:load',function(){
  // $('.dropdown-button').dropdown();
  $(".button-collapse").sideNav();
  $('.edit_task').submitOnCheck();
  $('.modal-trigger').modal();
// })

  // CHANGE IMAGE IN LIST NEW FILE UPLOAD
  $(document).on("mouseout", 'label[for="list_avatar"]', mouseOutAvatar);
  $(document).on("mouseover", 'label[for="list_avatar"]', mouseOverAvatar);

  //  change ownership
  $(document).on("click","a#btn-list-ownership-change",function(e){
      e.preventDefault;
      submit_ownership_change(e)
  })

  function submit_ownership_change(event) {
    var formData = new FormData(),
        $form_user_ownership_change = $("#user_ownership_change"),
        $new_owner = $("#list_owner",$form_user_ownership_change),
        $current_password = $("#change_ownership_password",$form_user_ownership_change);

    formData.append('list_owner', $new_owner.val());
    formData.append('current_password', $current_password.val());
    do_submit(formData);
    return false;
  }

  function keypressed(event) {
    alert("keypressed");
    var charcode = (event.which) ? event.which : window.event.keyCode;
    if (charcode == 13) {
      return submit_ownership_change(event);
    }
    return true;
  }

  function do_submit(submit_values) {

    $.ajax({
      url: $("#btn-list-ownership-change").data("src"),
      data: submit_values,
      cache: false,
      contentType: false,
      processData: false,
      type: 'POST',
      success: function(response) {

        if (response.status=="success"){
          Materialize.toast('Your changes were saved', 4000);
          var $current_password = $("#change_ownership_password");
          $current_password.val('');
          $('#change_ownership').collapsible('close', 0);
        }
        },error: function(xhr){

            if ($("#change_ownership .collapsible-body .ms-alert").length >0){
                $("#change_ownership .collapsible-body .ms-alert").remove();
              }
            var $collapsibleBody = $("#change_ownership .collapsible-body");
            $collapsibleBody.prepend('<div class="ms-alert ms-alert_error left-align fade show alert-dismissible"><ul></ul></div>');
            var $divError = $(".ms-alert ul", $collapsibleBody),
                errors = $.parseJSON(xhr.responseText).errors;

            jQuery.each( errors, function( i, val ) {
                $divError.append ('<li>' + val[0].message + '</li>')
              });
        }
    })
  }
// end change ownership

var app = window.app = {};

function split(val) {
    return val.split(/@\s*/);
}

function extractLast(term) {
    return split(term).pop();
}

/*******************  CREATE LIST **********************/
$(document).on('click','form#new_list a[data-behavior="submit"]', {}, function(event){
    var $form = $(this).parents('form');
    var $formData = new FormData(),
        val = 0;

    event.preventDefault();
    if ($("input#list_image").val() != 0){
      $formData.append('list[image]', $("input#list_image")[0].files[0]);
    }

    $formData.append('list[name]', $("input#list_name").val());
    $formData.append('list[description]', $("input#list_description").val());

    create_submit($formData,$form);

});

// CHANGE BUTTON TO ACTIVE WHEN LIST NAME IS NOT EMPTY
function create_submit(submit_values,form) {

  $.ajax({
    url: form.attr('action'),
    data: submit_values,
    cache: false,
    contentType: false,
    processData: false,
    type: 'POST',
    success: function(response) {

      if (response.status=="success"){
        form[0].reset();
        $('label[for="list_name"]').removeClass('active');
        $('label[for="list_description"]').removeClass('active');
        $("a[data-behavior='submit']",form).attr("disabled", true);
        Materialize.toast(response.flash, 4000);
        $('.ms-upload-avatar').css('background-image','none');
      } else if (response.status=="fail") {
          var $divError = $("#error_explanation");

          if ($divError.length > 0){
              $divError.remove();
            }
           form.prepend(response.htmlerrors);
           $.each(response.errors, function (index, value) {
              $("#new_list input[name='list["+index+"]']").addClass("invalid");
           })
      }
    },errors: function(xhr){
          var $divError = $("#error_explanation"),
          errors = $.parseJSON(xhr.responseText).errors;

          if ($divError.length > 0){
              $divError.html('');
            }

          $divError.html('<ul></ul>');
          jQuery.each( errors, function( i, val ) {
            $( 'ul', $divError).append ('<li>' + val[0].message + '<button type="button" class="close" data-dismiss="alert" aria-label="Close" onclick="close_error(event);" ><span aria-hidden="true">&times;</span></button></li>')
            });
      }
  })
}

function close_error(el){
console.log($(el).parents('ul'));
  if ($(el).parent().closest('li').length ==0)
     $(el).parent().remove();
  else
    $(el).parents("#error_explanation").remove();
}
$(document).on("keyup","form#new_list #list_name",function(){
  var $form = $(this).parents("form#new_list");

  if ($.trim($(this).val()).length !=0){
    $("a[data-behavior='submit']",$form).attr("disabled", false);
    $(this).removeClass("invalid");
    $('#error_explanation').remove();}
  else
    $("a[data-behavior='submit']",$form).attr("disabled", true);
})

// END CHANGE BUTTON TO ACTIVE WHEN LIST NAME IS NOT EMPTY


/******************* END CREATE LIST **********************/
